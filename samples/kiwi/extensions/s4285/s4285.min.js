var s4285_ext_name="s4285",s4285_first_time=!0;function s4285_main(){ext_switch_to_client(s4285_ext_name,s4285_first_time,s4285_recv),s4285_first_time||s4285_controls_setup(),s4285_first_time=!1}var s4285_imageData,s4285_map=new Uint32Array(4e4),s4285_max=1;function s4285_clear(){var e=s4285_canvas.ctx;e.fillStyle="mediumBlue",e.fillRect(0,0,200,200),e.fillStyle="white",e.fillRect(0,100,200,1),e.fillRect(100,0,1,200),ext_send("SET clear");for(var s=0;s<200;s++)for(var _=0;_<200;_++)s4285_map[200*s+_]=0;s4285_max=1}function s4285_density_draw(){for(var e=s4285_canvas.ctx,s=0,_=0;_<4e4;_+=200){for(var t=0;t<200;t++){var a=Math.round(s4285_map[_+t]/s4285_max*255);s4285_imageData.data[4*t+0]=color_map_r[a],s4285_imageData.data[4*t+1]=color_map_g[a],s4285_imageData.data[4*t+2]=color_map_b[a],s4285_imageData.data[4*t+3]=255}e.putImageData(s4285_imageData,0,s),s++}}var s4285_cmd_e={IQ_POINTS:0,IQ_DENSITY:1};function s4285_recv(e){if("DAT"!=arrayBufferToStringLen(e,3)){var s=arrayBufferToString(e).substring(4).split(" ");for(l=0;l<s.length;l++){var _=s[l].split("=");switch(_[0]){case"ready":s4285_controls_setup();break;case"status":var t=decodeURIComponent(_[1]);w3_el("id-s4285-status").innerHTML=t;break;default:console.log("s4285_recv: UNKNOWN CMD "+_[0])}}}else{var a=new Uint8Array(e,4),i=a[0],n=a.length-1;if(i==s4285_cmd_e.IQ_POINTS)for(var r=s4285_canvas.ctx,c=1;c<n;c+=4)l=a[c+0],o=a[c+1],r.fillStyle="black",r.fillRect(l,o,2,2),l=a[c+2],o=a[c+3],r.fillStyle="cyan",r.fillRect(l,o,2,2);else if(i==s4285_cmd_e.IQ_DENSITY){var l,o;for(r=s4285_canvas.ctx,c=1;c<n;c+=2){l=a[c+0],o=a[c+1];var d=s4285_map[200*o+l];++d>s4285_max&&(s4285_max=d),s4285_map[200*o+l]=d}}else console.log("s4285_recv: DATA UNKNOWN cmd="+i+" len="+(a.length-1))}}var s4285_canvas,s4285_density_interval,s4285_mode={MODE_RX:0,MODE_TX_LOOPBACK:1},s4285_mode_init=s4285_mode.MODE_TX_LOOPBACK,s4285_gain_init=5,s4285_points_init=10,s4285={mode:s4285_mode_init,gain:s4285_gain_init,draw:0,points:s4285_points_init};function s4285_controls_setup(){var e=time_display_html("s4285")+w3_div("id-s4285-data|left:100px; width:200px; height:200px; background-color:mediumBlue; overflow:hidden; position:relative;",'<canvas id="id-s4285-canvas" width="200" height="200" style="position:absolute"></canvas>'),s=w3_div("id-s4285-controls w3-text-aqua",w3_divs("w3-container/w3-tspace-8",w3_div("w3-medium w3-text-aqua","<b>STANAG 4285 decoder</b>"),w3_select("","Mode","","s4285.mode",s4285.mode,{0:"receive",1:"tx loopback"},"s4285_mode_select_cb"),w3_slider("","Gain","s4285.gain",s4285.gain,0,100,1,"s4285_gain_cb"),w3_select("","Draw","","s4285.draw",s4285.draw,{0:"points",1:"density"},"s4285_draw_select_cb"),w3_slider("","Points","s4285.points",s4285.points,4,14,1,"s4285_points_cb"),w3_button("","Clear","s4285_clear_cb"),w3_div("w3-text-aqua","<b>Status:</b>",w3_div("id-s4285-status w3-small w3-text-white"))));ext_panel_show(s,e,null),time_display_setup("s4285"),s4285_environment_changed({resize:1}),(s4285_canvas=w3_el("id-s4285-canvas")).ctx=s4285_canvas.getContext("2d"),s4285_imageData=s4285_canvas.ctx.createImageData(200,1),ext_set_mode("usb"),ext_set_passband(600,3e3),ext_send("SET mode="+s4285_mode_init),ext_send("SET run=1"),s4285_clear()}function s4285_environment_changed(e){if(e.resize){var s=w3_el("id-s4285-data"),_=(window.innerWidth-200-time_display_width())/2;s.style.left=px(_)}}function s4285_mode_select_cb(e,s){s=+s,ext_send("SET mode="+s)}function s4285_gain_cb(e,s){w3_num_cb(e,s),w3_set_label("Gain "+(0==s?"(auto-scale)":s+" dB"),e),ext_send("SET gain="+s),s4285_clear()}function s4285_points_cb(e,s){var _=1<<s;w3_num_cb(e,s),w3_set_label("Points "+_,e),ext_send("SET points="+_),s4285_clear()}function s4285_draw_select_cb(e,s){s=+s,ext_send("SET draw="+s),kiwi_clearInterval(s4285_density_interval),s==s4285_cmd_e.IQ_DENSITY&&(s4285_density_interval=setInterval(s4285_density_draw,250)),s4285_clear()}function s4285_clear_cb(e,s){s4285_clear(),setTimeout(function(){w3_radio_unhighlight(e)},w3_highlight_time)}function s4285_blur(){console.log("### s4285_blur"),ext_send("SET run=0"),msg_send("SET wf_speed=-1")}function s4285_config_html(){ext_admin_config(s4285_ext_name,"s4285",w3_div("id-s4285 w3-text-teal w3-hide","<b>s4285 configuration</b><hr>"))}