var gri_s=["5960 North Russia (Chayka)","5990 Caucasus","6000 China BPL Pucheng","6731 Anthorn UK","6780 China South Sea","7430 China North Sea","7950 Eastern Russia (Chayka)","8000 Western Russia (Chayka)","8390 China East Sea","8830 Saudi Arabia North","8970 Wildwood USA (testing)","9930 Korea"],gri_2s=["North Russia","(Chayka)","Caucasus","","China BPL","Pucheng","Anthorn UK","","China Sea","South","China Sea","North","Eastern Russia","(Chayka)","Western Russia","(Chayka)","China Sea","East","Saudi Arabia","North","Wildwood USA","(testing)","Korea",""],loran_c_default_chain1=7,loran_c_default_chain2=3,emission_delay={5960:[{s:"M Inta",d:0},{s:"X Tumanny Pen",d:14670.15},{s:"Z Norilsk",d:45915.33}],5990:[{s:"M Caucasian Center",d:0},{s:"X Caucasian West",d:16587},{s:"Y Caucasian East",d:31304},{s:"Z Caucasian North",d:46440}],6000:[{s:"M Pucheng",d:0}],6731:[{s:"M Anthorn",d:0},{s:"Y Anthorn",d:27300}],6780:[{s:"M Hexian",d:0},{s:"X Raoping",d:14464.69},{s:"Y Chongzuo",d:26925.76}],7430:[{s:"M Rongcheng",d:0},{s:"X Xuancheng",d:13459.7},{s:"Y Helong",d:30852.32}],7950:[{s:"M Aleksandrovsk",d:0},{s:"W Petropavlovsk",d:14506.5},{s:"X Ussuriisk",d:33678},{s:"Y (ex-Tokachibuto)",d:49104.15},{s:"Z Okhotsk",d:64102.05}],8000:[{s:"M Bryansk",d:0},{s:"W Petrozavodsk",d:13217.21},{s:"X Slonim",d:27125},{s:"Y Simferopol",d:53070.25},{s:"Z Syzran",d:67941.6}],8390:[{s:"M Xuancheng",d:0},{s:"X Raoping",d:13795.52},{s:"Y Rongcheng",d:31459.7}],8830:[{s:"M Afif",d:0},{s:"W Salwa",d:13645},{s:"X (ex-Al Khamasin)",d:27265},{s:"Y Ash Shaykh",d:42645},{s:"Z Al Muwassam",d:58790}],8970:[{s:"M Wildwood",d:0}],9930:[{s:"M Pohang",d:0},{s:"W Kwang Ju",d:11946.97},{s:"X (ex-Gesashi)",d:25565.52},{s:"Y (ex-Niijima)",d:40085.64},{s:"Z Ussuriisk",d:54162.44}]};function loran_c_main(){ext_switch_to_client(loran_c.ext_name,loran_c.first_time,loran_c_recv),loran_c.first_time||loran_c_controls_setup(),loran_c.first_time=!1}var loran_c_cmd_e={SCOPE_DATA:0,SCOPE_RESET:1},loran_c_sidebarx=15,loran_c_startx=125,loran_c_hlegend=20,loran_c_nbuckets=[];function loran_c_recv(a){if("DAT"!=arrayBufferToStringLen(a,3))for(var _=arrayBufferToString(a).substring(4).split(" "),r=0;r<_.length;r++){var n=_[r].split("=");switch(n[0]){case"ready":loran_c_controls_setup();break;case"ms_per_bin":loran_c_ms_per_bin=parseFloat(n[1]);break;default:console.log("loran_c_recv: UNKNOWN CMD "+n[0])}}else{var l=new Uint8Array(a,4),e=l[0];if(e==loran_c_cmd_e.SCOPE_DATA||e==loran_c_cmd_e.SCOPE_RESET){var o=l[1],c=l.length-2;loran_c_nbuckets[o]=c;var t=loran_c_startx,i=loran_c.scope.width,s=loran_c.scope.height,g=(o+1)*s/2-loran_c_hlegend,d=s/2-loran_c_hlegend;for(e==loran_c_cmd_e.SCOPE_RESET&&(loran_c.scope.ct.fillStyle="black",loran_c.scope.ct.fillRect(t,o*s/2,i-t,d)),r=0;r<c;r++){var p=l[2+r]/255;loran_c.scope.ct.fillStyle="black",loran_c.scope.ct.fillRect(t+r,g,1,-d),loran_c.scope.ct.fillStyle=o?"violet":"cyan",loran_c.scope.ct.fillRect(t+r,g,1,p*-d)}loran_c.scope.ct.fillStyle="black",loran_c.scope.ct.fillRect(t+r,g,i-t+r,-d)}else console.log("loran_c_recv: DATA UNKNOWN cmd="+e+" len="+(l.length-1))}}var loran_c_ms_per_bin,loran_c_station_colors=["red","yellow","lime","blue","grey"];function loran_c_draw_legend(a,_,r){loran_c.scope.width;var n=loran_c.scope.height,l=loran_c_sidebarx,e=loran_c_startx,o=(a+1)*n/2,c=loran_c_hlegend,t=n/2-c;loran_c.scope.ct.fillStyle="white",loran_c.scope.ct.fillText("GRI "+_,l,o-t/3-c-8);var i=w3_el(r).value;null!=i&&-1!=i&&(loran_c.scope.ct.fillText(gri_2s[2*i],l,o-t/3-c+8),loran_c.scope.ct.fillText(gri_2s[2*i+1],l,o-t/3-c+24));var s=emission_delay[_];if(null!=s)for(var g=0;g<s.length;g++){var d,p=s[g].d/1e3;d=g<s.length-1?s[g+1].d/1e3:_/100,p=Math.round(p/loran_c_ms_per_bin),d=Math.round(d/loran_c_ms_per_bin),loran_c.scope.ct.fillStyle=loran_c_station_colors[g],loran_c.scope.ct.fillRect(e+p,o-c,d-p,6),loran_c.scope.ct.fillStyle="white",loran_c.scope.ct.fillText(s[g].s,e+p,o-3)}}function loran_c_update_gri(a,_,r){var n=loran_c.scope.width,l=loran_c.scope.height,e=loran_c_sidebarx;loran_c.scope.ct.fillStyle="black",loran_c.scope.ct.fillRect(e,a*l/2,n-e,l/2),loran_c.scope.ct.font="12px Verdana",loran_c_draw_legend(a,r,_),ext_send("SET gri"+a+"="+r)}function loran_c_param_val(a,_){var r=_*loran_c_avg_param_max[a]/100;return loran_c_avg_param_max[a]>1&&(r=Math.ceil(r)),r<loran_c_avg_param_min[a]&&(r=loran_c_avg_param_min[a]),r}function loran_c_param_init(a){loran_c_slider_param_init[a]=Math.ceil(loran_c_avg_param_init[a]/loran_c_avg_param_max[a]*100)}var loran_c_nalgo=3,loran_c_avg_algo_e={CMA:0,EMA:1,IIR:2},loran_c_avg_algo_s={0:"CMA",1:"EMA",2:"IIR"},loran_c_avg_param_s={0:"Averages",1:"Decay",2:"Exp"},loran_c_avg_param_init={0:8,1:256,2:.2},loran_c_avg_param_min={0:1,1:1,2:0},loran_c_avg_param_max={0:32,1:512,2:1},loran_c_avg_param_cur=[],loran_c_slider_algo_init=loran_c_avg_algo_e.EMA,loran_c_slider_param_init=[];loran_c_param_init(loran_c_avg_algo_e.CMA),loran_c_param_init(loran_c_avg_algo_e.EMA),loran_c_param_init(loran_c_avg_algo_e.IIR);var loran_c={ext_name:"loran_c",first_time:!0,setup_init:!0,gri0:0,gri_sel0:0,gain0:0,offset0:0,avg_algo0:0,avg_param0:0,gri1:0,gri_sel1:0,gain1:0,offset1:0,avg_algo1:0,avg_param1:0,scope:null};function loran_c_controls_setup(){if(loran_c.setup_init){for(var a=0;a<2;a++){loran_c["avg_algo"+a]=loran_c_slider_algo_init,loran_c["avg_param"+a]=loran_c_slider_param_init[loran_c_slider_algo_init];for(var _=0;_<loran_c_nalgo;_++)loran_c_avg_param_cur[a*loran_c_nalgo+_]=loran_c_slider_param_init[_]}loran_c.setup_init=!1}var r=time_display_html("loran_c")+w3_div("id-loran_c-data|width:1224px; height:200px; background-color:black; position:relative;",'<canvas id="id-loran_c-scope" width="1224" height="200" style="position:absolute"></canvas>'),n=loran_c.gri0;0==n&&(0!=(n=ext_get_cfg_param("loran_c.gri0"))&&null!=n&&null!=n||(n=parseInt(gri_s[loran_c_default_chain1])),loran_c.gri0=n);var l=loran_c.gri1;0==l&&(0!=(l=ext_get_cfg_param("loran_c.gri1"))&&null!=l&&null!=l||(l=parseInt(gri_s[loran_c_default_chain2])),loran_c.gri1=l);var e=w3_div("id-loran_c-controls w3-text-white",w3_col_percent("",w3_div("w3-medium w3-text-aqua","<b>Loran-C viewer</b>"),40,w3_div("",'See also <b><a href="http://df6nm.bplaced.net/LoranView/LoranGrabber.htm" target="_blank">LoranView</a></b> by DF6NM'),60),w3_half("","",w3_divs("w3-margin-T-8 w3-margin-R-10",w3_col_percent("",w3_input("w3-padding-smaller","GRI","loran_c.gri0",loran_c.gri0,"loran_c_gri_cb"),25),w3_select("","GRI","select","loran_c.gri_sel0",0,gri_s,"loran_c_gri_select_cb"),w3_slider("","Gain (auto-scale)","loran_c.gain0",loran_c.gain0,0,100,1,"loran_c_gain_cb"),w3_select("","Averaging","","loran_c.avg_algo0",loran_c.avg_algo0,loran_c_avg_algo_s,"loran_c_avg_algo_select_cb"),w3_slider("","?","loran_c.avg_param0",loran_c.avg_param0,0,100,1,"loran_c_avg_param_cb")),w3_divs("w3-margin-T-8 w3-margin-R-10",w3_col_percent("",w3_input("w3-padding-smaller","GRI","loran_c.gri1",loran_c.gri1,"loran_c_gri_cb"),25),w3_select("","GRI","select","loran_c.gri_sel1",0,gri_s,"loran_c_gri_select_cb"),w3_slider("","Gain (auto-scale)","loran_c.gain1",loran_c.gain1,0,100,1,"loran_c_gain_cb"),w3_select("","Averaging","","loran_c.avg_algo1",loran_c.avg_algo1,loran_c_avg_algo_s,"loran_c_avg_algo_select_cb"),w3_slider("","?","loran_c.avg_param1",loran_c.avg_param1,0,100,1,"loran_c_avg_param_cb"))));ext_tune(100,"am",ext_zoom.ABS,8),ext_panel_show(e,r,null),ext_set_controls_width_height(525,290),time_display_setup("loran_c"),loran_c.scope=w3_el("id-loran_c-scope"),loran_c.scope.ct=loran_c.scope.getContext("2d"),loran_c.scope.addEventListener("mousedown",loran_c_mousedown,!1),ext_send("SET start")}function loran_c_mousedown(a){var _=(a.clientY?a.clientY:a.offsetY?a.offsetY:a.layerY)<loran_c.scope.height/2?0:1,r=(a.clientX?a.clientX:a.offsetX?a.offsetX:a.layerX)-loran_c_startx;r<0||r>=loran_c_nbuckets[_]||ext_send("SET offset"+_+"="+r)}function loran_c_blur(){ext_send("SET stop")}function loran_c_gri_cb(a,_){w3_num_cb(a,_);var r=a.replace("gri","gri_sel");loran_c_gri_select_cb(r,-1),loran_c_update_gri(parseInt(a.charAt(a.length-1)),r,_)}function loran_c_gri_select_cb(a,_,r){_=+_;var n=a.replace("_sel","");if(r||-1==_){var l=w3_get_value(n),e=!1;w3_select_enum(a,function(_){var r=_.value;r>=0&&l==parseInt(gri_s[r])&&(w3_select_value(a,_.value),e=!0)}),e||w3_select_value(a,-1)}else{l=parseInt(gri_s[_]);w3_num_cb(n,l),w3_set_value(n,l)}loran_c_update_gri(parseInt(a.charAt(a.length-1)),a,l)}function loran_c_gain_cb(a,_){w3_num_cb(a,_),w3_set_label("Gain "+(0==_?"(auto-scale)":_+" dB"),a);var r=parseInt(a.charAt(a.length-1));ext_send("SET gain"+r+"="+_)}function loran_c_avg_algo_select_cb(a,_){_=+_,w3_num_cb(a,_);var r=_,n=parseInt(a.charAt(a.length-1));ext_send("SET avg_algo"+n+"="+r);var l,e=a.replace("algo","param");null==(l=loran_c_avg_param_cur[n*loran_c_nalgo+r])&&(l=loran_c_slider_param_init[r],console.log("loran_c_slider_param_init="+l+"/100")),loran_c_avg_param_cb(e,l),w3_set_value(e,l)}function loran_c_avg_param_cb(a,_){w3_num_cb(a,_);var r=a.replace("param","algo"),n=+w3_get_value(r),l=parseInt(a.charAt(a.length-1)),e=loran_c_param_val(n,_);ext_send("SET avg_param"+l+"="+e.toFixed(2)),loran_c_avg_param_cur[l*loran_c_nalgo+n]=+_,w3_set_label(loran_c_avg_param_s[n]+" "+e,a)}function loran_c_config_html(){ext_admin_config(loran_c.ext_name,"Loran-C",w3_div("id-loran_c w3-text-teal w3-hide","<b>Loran-C configuration</b><hr>"+w3_div("w3-show-inline-block",w3_div("w3-container w3-show-inline-block|width:200px",w3_divs("w3-margin-bottom",w3_input_get("","default GRI 0","loran_c.gri0","w3_num_set_cfg_cb",""),w3_input_get("","default GRI 1","loran_c.gri1","w3_num_set_cfg_cb",""))))))}