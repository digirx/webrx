var integrate_ext_name="integrate",integrate_first_time=!0;function integrate_main(){ext_switch_to_client(integrate_ext_name,integrate_first_time,integrate_recv),integrate_first_time||integrate_controls_setup(),integrate_first_time=!1}var integ_bins,integrate_update_interval,integ_w=1024,integ_th=200,integ_hdr=12,integ_h=integ_th-integ_hdr,integ_yo=0,integ_bino=0,integ_draw=!1;function integrate_clear(){var t;ext_send("SET clear"),integ_draw=!1,(t=integrate_data_canvas.ctx).fillStyle="mediumBlue",t.fillRect(0,0,integ_w,integ_th),(t=integrate_info_canvas.ctx).fillStyle="#575757",t.fillRect(0,0,256,280);var e=w3_el("integrate-controls-left"),a=w3_el("integrate-controls-right");switch(integrate_preset){case 0:ext_set_controls_width_height(void 0,290),e.style.width="49.9%",a.style.width="49.9%",integrate_alpha();break;default:ext_set_controls_width_height(275,290),e.style.width="0%",a.style.width="100%";var i=ext_get_freq();integrate_marker((i/1e3).toFixed(2),!1,i)}}var integ_last_freq=0,integ_last_offset=0;function integrate_update(){var t=ext_get_freq(),e=t-ext_get_carrier_freq();t==integ_last_freq&&e==integ_last_offset||(integrate_clear(),integ_last_freq=t,integ_last_offset=e)}function integrate_marker(t,e,a){var i=integrate_data_canvas.ctx,n=integ_w/ext_sample_rate();t=e?t+"▼":"▼"+t,i.font="12px Verdana",i.fillStyle="white";var _=(a-ext_get_carrier_freq())*n,r=i.measureText("▼").width/2-(e?-1:2),l=Math.round(integ_w/2-1+_+(e?-i.measureText(t).width+r:-r));i.fillText(t,l,10)}var integ_dbl,integ_maxdb,integ_mindb,integrate_cmd_e={FFT:0,CLEAR:1};function integrate_mousedown(t){var e=(t.clientY?t.clientY:t.offsetY?t.offsetY:t.layerY)-integ_yo;if(!(e<0||e>=integ_h)){var a=Math.round(e/integ_dbl);a<0||a>integ_bins||(integ_bino=Math.round((integ_bino+a)%integ_bins))}}function integrate_recv(t){if("DAT"!=arrayBufferToStringLen(t,3))for(var e=arrayBufferToString(t).substring(4).split(" "),a=0;a<e.length;a++){var i=e[a].split("=");switch(i[0]){case"ready":integrate_controls_setup();break;case"bins":integ_bins=parseInt(i[1]),integ_bino=0,(integ_dbl=Math.floor(integ_h/integ_bins))<1&&(integ_dbl=1),(integ_yo=(integ_h-integ_dbl*integ_bins)/2)<0&&(integ_yo=0),integ_yo+=integ_hdr,integ_draw=!0;break;default:console.log("integrate_recv: UNKNOWN CMD "+i[0])}}else{var n=new Uint8Array(t,4),_=n[0],r=1,l=n.length-1;if(_==integrate_cmd_e.FFT){if(!integ_draw)return;var g=integrate_data_canvas.ctx,s=integrate_data_canvas.im,o=n[r];r++,l--,(o-=integ_bino)<0&&(o+=integ_bins);for(var d=0;d<integ_w;d++){var c=waterfall_color_index_max_min(n[d+r],integ_maxdb,integ_mindb);s.data[4*d+0]=color_map_r[c],s.data[4*d+1]=color_map_g[c],s.data[4*d+2]=color_map_b[c],s.data[4*d+3]=255}for(var h=0;h<integ_dbl;h++)g.putImageData(s,0,integ_yo+(o*integ_dbl+h))}else _==integrate_cmd_e.CLEAR?integrate_clear():console.log("integrate_recv: DATA UNKNOWN cmd="+_+" len="+l)}}var integrate_data_canvas,integrate_info_canvas,integrate_itime_init=10,integrate_maxdb_init=-10,integrate_mindb_init=-134,integrate={itime:integrate_itime_init,pre:0,maxdb:integrate_maxdb_init,mindb:integrate_mindb_init};function integrate_controls_setup(){integrate_preset=-1;var t=time_display_html("integrate")+w3_div("id-integrate-data|left:150px; width:1024px; height:200px; background-color:mediumBlue; position:relative;",'<canvas id="id-integrate-data-canvas" width="1024" height="200" style="position:absolute"></canvas>'),e=w3_div("id-integrate-info|left:0px; height:280px; overflow:hidden; position:relative;",'<canvas id="id-integrate-info-canvas" width="256" height="280" style="position:absolute"></canvas>');dbgUs&&(integrate.pre=1);var a=w3_div("id-integrate-controls w3-text-white",w3_half("","",e,w3_divs("w3-container/w3-tspace-8",w3_div("w3-medium w3-text-aqua","<b>Audio integration</b>"),w3_input("w3-width-64 w3-padding-smaller","Integrate time (secs)","integrate.itime",integrate.itime,"integrate_itime_cb"),w3_select("","Presets","select","integrate.pre",-1,{0:"Alpha (RSDN-20)",1:"40 JJY",2:"60 WWVB/MSF/JJY",3:"200/3 RBU",4:"68.5 BPC",5:"77.5 DCF77"},"integrate_pre_select_cb"),w3_slider("","WF max","integrate.maxdb",integrate.maxdb,-100,20,1,"integrate_maxdb_cb"),w3_slider("","WF min","integrate.mindb",integrate.mindb,-190,-30,1,"integrate_mindb_cb"),w3_button("","Clear","integrate_clear_cb")),"id-integrate-controls-left","id-integrate-controls-right"));ext_panel_show(a,t,null),time_display_setup("integrate"),(integrate_data_canvas=w3_el("id-integrate-data-canvas")).ctx=integrate_data_canvas.getContext("2d"),integrate_data_canvas.im=integrate_data_canvas.ctx.createImageData(integ_w,1),integrate_data_canvas.addEventListener("mousedown",integrate_mousedown,!1),(integrate_info_canvas=w3_el("id-integrate-info-canvas")).ctx=integrate_info_canvas.getContext("2d"),integrate_environment_changed({resize:1}),integrate_itime_cb("integrate.itime",integrate.itime),ext_send("SET run=1"),integrate_clear(),integrate_update_interval=setInterval(integrate_update,1e3)}function integrate_environment_changed(t){if(t.resize){var e=w3_el("id-integrate-data"),a=(window.innerWidth-integ_w-time_display_width())/2;e.style.left=px(a)}}var alpha={KRAS:1,NOVO:2,KHAB:3,REVD:4,SEYD:5,MULT:6},alpha_stations=["Krasnodar 38°E","Novosibirsk 84°E","Khabarovsk 136°E","Revda 34°E","Seyda 62°E"],alpha_station_colors=["yellow","red","lime","cyan","magenta"],alpha_freqs=[],alpha_sched={0:["F1","F4/5","F2","F3/p"],1:[11.9,12.09,12.65,14.88],2:[!0,!1,!1,!1],3:[alpha.NOVO,0,alpha.REVD,alpha.KRAS],4:[alpha.SEYD,alpha.REVD,alpha.NOVO,alpha.KHAB],5:[alpha.KRAS,alpha.SEYD,alpha.KHAB,alpha.NOVO],6:[alpha.KHAB,0,alpha.KRAS,alpha.MULT],7:[alpha.REVD,0,0,alpha.SEYD],8:[0,0,alpha.SEYD,alpha.REVD]};function integrate_alpha(){var t=16;(r=integrate_info_canvas.ctx).font="12px Verdana";for(var e=0;e<4;e++){r.fillStyle="white";var a=alpha_sched[0][e],i=4.5-r.measureText(a).width/2;r.fillText(a,64+48*e+i,10);a=alpha_sched[1][e].toFixed(2),i=4.5-r.measureText(a).width/2;r.fillText(a,64+48*e+i,26),t=32;for(var n=1;n<=6;n++){0==e&&(r.fillStyle="white",r.fillText("slot "+n,16,t+15)),(_=alpha_sched[n+2][e])==alpha.MULT?(r.fillStyle=alpha_station_colors[alpha.NOVO-1],r.fillRect(64+48*e-5,t,5,20),r.fillStyle=alpha_station_colors[alpha.REVD-1],r.fillRect(64+48*e+2,t,5,20),r.fillStyle=alpha_station_colors[alpha.SEYD-1],r.fillRect(64+48*e+9,t,5,20)):_&&(r.fillStyle=alpha_station_colors[_-1],r.fillRect(64+48*e,t,9,20)),t+=24}}t=192,r.font="12px Verdana";for(var _=0;_<=4;_++)r.fillStyle=alpha_station_colors[_],r.fillRect(64,t,20,9),r.fillStyle="white",r.fillText(alpha_stations[_],88,t+9),t+=16;var r=integrate_data_canvas.ctx;ext_sample_rate();r.font="12px Verdana",r.fillStyle="white";for(e=0;e<4;e++){var l=alpha_sched[1][e].toFixed(2),g=1e3*parseFloat(l);integrate_marker(l,alpha_sched[2][e],g)}}function integrate_itime_cb(t,e){var a=parseFloat(e);a<1&&(a=1),a=a.toFixed(3),w3_num_cb(t,a),ext_send("SET itime="+a),integrate_clear()}function integrate_set_itime(t){w3_set_value("integrate.itime",t),integrate_itime_cb("integrate.itime",t)}var integrate_preset=-1;function integrate_pre_select_cb(t,e){switch(integ_draw=!1,integrate_preset=e=+e){case 0:ext_tune(11.5,"usb",ext_zoom.NOM_IN),ext_set_passband(300,3470),integrate_set_itime(3.6);break;case 1:ext_tune(40,"cw",ext_zoom.NOM_IN),integrate_set_itime(1);break;case 2:ext_tune(60,"cw",ext_zoom.NOM_IN),integrate_set_itime(1);break;case 3:ext_tune(66.35,"cw",ext_zoom.NOM_IN),integrate_set_itime(1);break;case 4:ext_tune(68.5,"cw",ext_zoom.NOM_IN),integrate_set_itime(1);break;case 5:ext_tune(77.5,"cw",ext_zoom.NOM_IN),integrate_set_itime(1)}}function integrate_maxdb_cb(t,e,a,i){integ_maxdb=parseFloat(e),w3_num_cb(t,e),w3_set_label("WF max "+e+" dBFS",t)}function integrate_mindb_cb(t,e,a,i){integ_mindb=parseFloat(e),w3_num_cb(t,e),w3_set_label("WF min "+e+" dBFS",t)}function integrate_clear_cb(t,e){integrate_clear(),setTimeout(function(){w3_radio_unhighlight(t)},w3_highlight_time)}function integrate_blur(){kiwi_clearInterval(integrate_update_interval)}function integrate_config_html(){ext_admin_config(integrate_ext_name,"Integrate",w3_div("id-integrate w3-text-teal w3-hide","<b>Audio integration configuration</b><hr>"))}