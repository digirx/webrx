var timecode_ext_name="timecode",tc_first_time=!0;function timecode_main(){ext_switch_to_client(timecode_ext_name,tc_first_time,tc_recv_msg),tc_first_time||tc_controls_setup(),tc_first_time=!1}var isFullMin,sec_per_sweep,tc_dbug="";function tc_dmsg(t){null==t?tc_dbug="":tc_dbug+=t,w3_el("id-tc-dbug").innerHTML=tc_dbug}function tc_stat(t,c){w3_el("id-tc-status").style.color=t,w3_el("id-tc-status").innerHTML=c}function tc_stat2(t,c){w3_el("id-tc-status2").style.color=t,w3_el("id-tc-status2").innerHTML=c}var tc={srate:0,srate_2pi:0,interval:0,need_pll:0,scope_ct:null,scope_run:1,scope_bg:"#f2f2f2",ten_sec:0,mkr_per:0,mkr:0};function tc_scope_clr(){}function tc_scope(t,c,e,_){}function tc_test(t,c,e){}var tc_inverted,tc_dcnt,tc_min,tc_time0,tc_time0_copy,tc_state,bits=[],dbits="",tc_cur=0,tc_phdata=0,tc_phdata_last=0,tc_cnt=0,tc_width=0,tc_trig=0,tc_sample_point=-1,tc_recv=0,TC_NOISE_THRESHOLD=15,tc_data=[],tc_mo=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],tc_dim=[31,28,31,30,31,30,31,31,30,31,30,31],tc_MpD=1440,tc_MpY=365*tc_MpD,tc_sixmin_mode=0,tc_st={ACQ_SYNC:0,ACQ_DATA:1,ACQ_SIXMIN:2},tc_pll={phase:0,freq:0,lpf_coeff:.01,lpf_re:0,lpf_im:0,lpf_ph_err:0,alpha:1e-12,beta:1e-7};function tc_audio_data_cb(t,c){for(var e=0;e<c;e++){if(tc.need_pll){var _=t[e],i=_*Math.cos(tc_pll.phase),s=_*Math.sin(tc_pll.phase);tc_pll.lpf_re+=tc_pll.lpf_coeff*(i-tc_pll.lpf_re),tc_pll.lpf_im+=tc_pll.lpf_coeff*(s-tc_pll.lpf_im);var l=Math.atan2(tc_pll.lpf_re,tc_pll.lpf_im);tc_pll.lpf_ph_err+=tc_pll.lpf_coeff*(l-tc_pll.lpf_ph_err);var a=tc_pll.lpf_re;tc_pll.freq+=a*tc_pll.alpha,tc_pll.phase+=tc_pll.freq+a*tc_pll.beta}var o=-tc_pll.lpf_ph_err,r=o>1.5?1:o<-1.5?1:0,p=r?3.1:void 0;switch(tc_config.sig){case tc_sig.test:tc_test(samp_real,o,r),tc_scope(p,tc_trig==tc_sample_point?2.5:ampl,tc_phdata?1.8:void 0,o);break;case tc_sig.WWVBp:tc_scope(p,tc_trig==tc_sample_point?2.5:ampl,tc_phdata?1.8:void 0,o);break;case tc_sig.MSF:tc_scope(p,tc.mkr?2.5:ampl,o,void 0);break;case tc_sig.TDF:default:tc_scope(2*o,tc.mkr?2.5:0,void 0,void 0)}}}function tc_recv_msg(t){for(var c=arrayBufferToString(t).substring(4).split(" "),e=0;e<c.length;e++){var _=c[e].split("=");switch("keepalive"!=_[0]&&(void 0!==_[1]?console.log("tc_recv: "+_[0]+"="+_[1]):console.log("tc_recv: "+_[0])),_[0]){case"ready":kiwi_load_js_dir("extensions/timecode/",["wwvb.js","tdf.js"],"tc_controls_setup");break;default:console.log("tc_recv: UNKNOWN CMD "+_[0])}}}var tc_sig={JJY40:0,WWVBa:1,WWVBp:2,JJY60:3,MSF:4,BPC:5,DCF77a:6,TDF:7,test:8},tc_sig_s=["40 kHz JJY","60 kHz WWVB ampl","60 kHz WWVB phase","60 kHz JJY","60 kHz MSF","68.5 kHz BPC","77.5 kHz DCF77 ampl","162 kHz TDF","1107 kHz test"],tc_freq={0:40,1:60,2:60,3:60,4:60,5:68.5,6:77.5,7:162,8:1107},tc_config={sig:tc_sig.WWVBp};function tc_controls_setup(){var t=time_display_html("tc")+w3_div("id-tc-data|width:1024px; height:200px; background-color:black; position:relative;",'<canvas id="id-tc-scope" width="1024" height="200" style="position:absolute"></canvas>'),c=w3_div("id-tc-controls w3-text-white",w3_div("w3-medium w3-text-aqua","<b>Time station timecode decoder</b>"),w3_divs("w3-margin-T-8/w3-show-inline w3-margin-right",w3_select("","","","tc_config.sig",tc_config.sig,tc_sig_s,"tc_signal_menu_cb"),w3_div("id-tc-status w3-show-inline-block"),w3_div("id-tc-status2 w3-show-inline-block")),'<pre><span id="id-tc-dbug"></span></pre>');ext_panel_show(c,t,null),time_display_setup("tc"),tc_environment_changed({resize:1}),ext_set_controls_width_height(1024);var e=ext_param();if(e){var _;for(e=e.toLowerCase(),_=0;_<tc_sig_s.length&&!tc_sig_s[_].toLowerCase().includes(e);_++);_<tc_sig_s.length&&(w3_select_value("tc_config.sig",_),tc_config.sig=_)}tc.scope_ct=w3_el("id-tc-scope").getContext("2d"),tc_scope_clr(),tc.srate=ext_sample_rate(),console.log("srate="+tc.srate),ext_register_audio_data_cb(tc_audio_data_cb)}function tc_environment_changed(t){if(t.resize){var c=w3_el("id-tc-data"),e=(window.innerWidth-1024-time_display_width())/2;c.style.left=px(e)}}function tc_signal_menu_cb(t,c){switch(c=+c,tc_config.sig=c,tc_dmsg(),tc_state=tc_st.ACQ_SYNC,tc_stat("yellow","Looking for sync"),tc_scope_clr(),tc.need_pll=1,isFullMin=0,sec_per_sweep=10,c){case tc_sig.test:ext_tune(tc_freq[c],"cwn",ext_zoom.ABS,12),tc.need_pll=1;break;case tc_sig.WWVBp:case tc_sig.MSF:ext_tune(tc_freq[c],"cwn",ext_zoom.ABS,12);break;case tc_sig.TDF:default:ext_tune(tc_freq[c],"cwn",ext_zoom.ABS,12),sec_per_sweep=1}if(tc.need_pll){tc.srate=ext_sample_rate(),tc.srate_2pi=2*tc.srate*Math.PI;var e=ext_get_passband(),_=e.low+(e.high-e.low)/2;tc_pll.phase=0,tc_pll.freq=_/tc.srate_2pi}}function timecode_blur(){kiwi_clearInterval(tc.interval),ext_unregister_audio_data_cb()}